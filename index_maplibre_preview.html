<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Control Room - MapLibre Preview</title>
    <script>
    (function blockFileProtocolMode() {
        if (window.location.protocol !== "file:") return;
        const localBase = "http://localhost:8000";
        const localUrl = localBase + "/index_maplibre_preview.html" + window.location.search + window.location.hash;
        document.open();
        document.write(
            "<!doctype html><html lang='en'><head><meta charset='utf-8'><title>Control Room - Start Local Server</title>" +
            "<meta name='viewport' content='width=device-width, initial-scale=1'>" +
            "<style>" +
            "body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:#0f172a;color:#e2e8f0;display:grid;place-items:center;min-height:100vh;padding:20px;}" +
            ".card{max-width:760px;background:#111827;border:1px solid #334155;border-radius:14px;padding:22px;box-shadow:0 20px 50px rgba(0,0,0,.35);}" +
            "h1{margin:0 0 10px;font-size:22px;}p{line-height:1.45;margin:8px 0 0;}" +
            "code{background:#0b1220;border:1px solid #334155;border-radius:6px;padding:2px 6px;}" +
            ".cmd{margin-top:12px;background:#0b1220;border:1px solid #334155;border-radius:8px;padding:10px 12px;font-family:Consolas,monospace;}" +
            ".row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;}" +
            "a{display:inline-block;text-decoration:none;background:#2563eb;color:#fff;padding:10px 14px;border-radius:8px;font-weight:600;}" +
            ".pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #334155;background:#0b1220;font-size:12px;}" +
            ".muted{opacity:.85;font-size:14px;margin-top:10px;}" +
            "</style></head><body><main class='card'>" +
            "<h1>Run MapLibre preview over HTTP</h1>" +
            "<p>Preview pages opened as <code>file://</code> cannot load local data due to browser CORS restrictions.</p>" +
            "<p>Start the included server from this project folder:</p>" +
            "<div class='cmd'>python scripts/dev_server.py</div>" +
            "<div class='row'><a href='" + localUrl + "'>Open http://localhost:8000</a><span id='cr-server-status' class='pill'>Checking localhost...</span></div>" +
            "<p class='muted'>This page auto-redirects when the local server responds.</p>" +
            "<script>(function(){var health='" + localBase + "/__control_room_health';var target='" + localUrl + "';var badge=document.getElementById('cr-server-status');function setLabel(t){if(badge)badge.textContent=t;}function ping(){fetch(health,{cache:'no-store'}).then(function(r){if(r.ok){setLabel('Server online. Redirecting...');window.location.replace(target);}else{setLabel('Server not reachable');setTimeout(ping,1200);}}).catch(function(){setLabel('Server not reachable');setTimeout(ping,1200);});}ping();})();<\/script>" +
            "</main></body></html>"
        );
        document.close();
        throw new Error("MapLibre preview must run over http://localhost:8000, not file://");
    })();
    </script>

    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet">
    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>

    <style>
        body { margin:0; padding:0; font-family: "Segoe UI", Tahoma, sans-serif; }
        #map { width:100%; height:100vh; }
        .preview-controls {
            position: absolute;
            top: 12px;
            left: 12px;
            z-index: 5;
            width: min(340px, calc(100vw - 24px));
            background: rgba(12, 19, 26, 0.92);
            border: 1px solid rgba(56, 189, 248, 0.34);
            border-radius: 10px;
            color: #dbeafe;
            padding: 10px 12px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.35);
        }
        .preview-title {
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-bottom: 8px;
            color: #7dd3fc;
        }
        .preview-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .preview-row label { font-size: 12px; }
        .preview-status {
            font-size: 11px;
            line-height: 1.4;
            color: #bfdbfe;
            background: rgba(15, 23, 42, 0.55);
            border: 1px solid rgba(148, 163, 184, 0.28);
            border-radius: 7px;
            padding: 7px 8px;
            margin-bottom: 8px;
        }
        .preview-note {
            font-size: 10px;
            color: #93c5fd;
            line-height: 1.4;
        }
    </style>
</head>

<body>
    <div class="preview-controls">
        <div class="preview-title">UK Rail Vector View</div>
        <div id="rail-status" class="preview-status">Loading single-source rail map...</div>
        <div class="preview-note">
            Source: OpenRailwayMap standard style (single provider). Display constrained to UK bounds.
        </div>
    </div>
    <div id="map"></div>

    <script>
    const ormConfig = {
        styleUrl: "https://openrailwaymap.app/style/standard.json"
    };
    const ukBounds = [
        [-11.5, 49.5],
        [2.8, 61.2]
    ];
    const searchParams = new URLSearchParams(window.location.search);
    const requestedLng = Number(searchParams.get("lng"));
    const requestedLat = Number(searchParams.get("lat"));
    const requestedZoom = Number(searchParams.get("z"));
    const hasRequestedView =
        Number.isFinite(requestedLng) &&
        Number.isFinite(requestedLat) &&
        Number.isFinite(requestedZoom);
    const startCenter = hasRequestedView ? [requestedLng, requestedLat] : [-2.5879, 51.4545];
    const startZoom = hasRequestedView ? Math.max(5, Math.min(13, requestedZoom)) : 6;

    function setRailStatus(message, kind = "info") {
        const el = document.getElementById("rail-status");
        if (!el) return;
        el.textContent = message;
        if (kind === "error") {
            el.style.borderColor = "rgba(239,68,68,0.45)";
            el.style.color = "#fecaca";
        } else if (kind === "ok") {
            el.style.borderColor = "rgba(34,197,94,0.38)";
            el.style.color = "#bbf7d0";
        } else {
            el.style.borderColor = "rgba(148, 163, 184, 0.28)";
            el.style.color = "#bfdbfe";
        }
    }

    let map = null;

    (async function initMap() {
        map = new maplibregl.Map({
            container: "map",
            style: ormConfig.styleUrl,
            center: startCenter,
            zoom: startZoom,
            minZoom: 5,
            maxZoom: 20,
            maxBounds: ukBounds
        });

        map.addControl(new maplibregl.NavigationControl(), "top-right");
        map.addControl(new maplibregl.AttributionControl({
            compact: true,
            customAttribution: '<a href="https://github.com/hiddewie/OpenRailwayMap-vector" target="_blank" rel="noopener noreferrer">OpenRailwayMap-vector</a> | <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener noreferrer">OpenStreetMap contributors</a>'
        }));

        map.on("load", () => {
            if (!hasRequestedView) {
                map.fitBounds(ukBounds, { padding: 28, duration: 0 });
            }
            setRailStatus("Rail map loaded from single source.", "ok");
        });

        map.on("error", () => {
            setRailStatus("Rail map source unavailable.", "error");
        });
    })();
    </script>
</body>
</html>
