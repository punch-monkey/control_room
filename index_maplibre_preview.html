<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Control Room - MapLibre Preview</title>
    <script>
    (function blockFileProtocolMode() {
        if (window.location.protocol !== "file:") return;
        const localBase = "http://localhost:8000";
        const localUrl = localBase + "/index_maplibre_preview.html" + window.location.search + window.location.hash;
        document.open();
        document.write(
            "<!doctype html><html lang='en'><head><meta charset='utf-8'><title>Control Room - Start Local Server</title>" +
            "<meta name='viewport' content='width=device-width, initial-scale=1'>" +
            "<style>" +
            "body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:#0f172a;color:#e2e8f0;display:grid;place-items:center;min-height:100vh;padding:20px;}" +
            ".card{max-width:760px;background:#111827;border:1px solid #334155;border-radius:14px;padding:22px;box-shadow:0 20px 50px rgba(0,0,0,.35);}" +
            "h1{margin:0 0 10px;font-size:22px;}p{line-height:1.45;margin:8px 0 0;}" +
            "code{background:#0b1220;border:1px solid #334155;border-radius:6px;padding:2px 6px;}" +
            ".cmd{margin-top:12px;background:#0b1220;border:1px solid #334155;border-radius:8px;padding:10px 12px;font-family:Consolas,monospace;}" +
            ".row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;}" +
            "a{display:inline-block;text-decoration:none;background:#2563eb;color:#fff;padding:10px 14px;border-radius:8px;font-weight:600;}" +
            ".pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #334155;background:#0b1220;font-size:12px;}" +
            ".muted{opacity:.85;font-size:14px;margin-top:10px;}" +
            "</style></head><body><main class='card'>" +
            "<h1>Run MapLibre preview over HTTP</h1>" +
            "<p>Preview pages opened as <code>file://</code> cannot load local data due to browser CORS restrictions.</p>" +
            "<p>Start the included server from this project folder:</p>" +
            "<div class='cmd'>python scripts/dev_server.py</div>" +
            "<div class='row'><a href='" + localUrl + "'>Open http://localhost:8000</a><span id='cr-server-status' class='pill'>Checking localhost...</span></div>" +
            "<p class='muted'>This page auto-redirects when the local server responds.</p>" +
            "<script>(function(){var health='" + localBase + "/__control_room_health';var target='" + localUrl + "';var badge=document.getElementById('cr-server-status');function setLabel(t){if(badge)badge.textContent=t;}function ping(){fetch(health,{cache:'no-store'}).then(function(r){if(r.ok){setLabel('Server online. Redirecting...');window.location.replace(target);}else{setLabel('Server not reachable');setTimeout(ping,1200);}}).catch(function(){setLabel('Server not reachable');setTimeout(ping,1200);});}ping();})();<\/script>" +
            "</main></body></html>"
        );
        document.close();
        throw new Error("MapLibre preview must run over http://localhost:8000, not file://");
    })();
    </script>

    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet">
    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>

    <style>
        body { margin:0; padding:0; font-family: "Segoe UI", Tahoma, sans-serif; }
        #map { width:100%; height:100vh; }
        .preview-controls {
            position: absolute;
            top: 12px;
            left: 12px;
            z-index: 5;
            width: min(340px, calc(100vw - 24px));
            background: rgba(12, 19, 26, 0.92);
            border: 1px solid rgba(56, 189, 248, 0.34);
            border-radius: 10px;
            color: #dbeafe;
            padding: 10px 12px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.35);
        }
        .preview-title {
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-bottom: 8px;
            color: #7dd3fc;
        }
        .preview-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .preview-row label { font-size: 12px; }
        .preview-status {
            font-size: 11px;
            line-height: 1.4;
            color: #bfdbfe;
            background: rgba(15, 23, 42, 0.55);
            border: 1px solid rgba(148, 163, 184, 0.28);
            border-radius: 7px;
            padding: 7px 8px;
            margin-bottom: 8px;
        }
        .preview-note {
            font-size: 10px;
            color: #93c5fd;
            line-height: 1.4;
        }
        .ops-block {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(148, 163, 184, 0.22);
        }
        .ops-label {
            display: block;
            font-size: 11px;
            margin-bottom: 4px;
            color: #bfdbfe;
        }
        .ops-input, .ops-select {
            width: 100%;
            box-sizing: border-box;
            background: rgba(15, 23, 42, 0.72);
            color: #e2e8f0;
            border: 1px solid rgba(148, 163, 184, 0.35);
            border-radius: 6px;
            padding: 7px 8px;
            font-size: 12px;
            margin-bottom: 6px;
        }
        .ops-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 6px;
        }
        .ops-btn {
            background: #1d4ed8;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 6px 8px;
            font-size: 11px;
            cursor: pointer;
        }
        .ops-btn.alt {
            background: #334155;
        }
        .ops-results {
            max-height: 220px;
            overflow: auto;
            font-size: 11px;
            line-height: 1.4;
            background: rgba(15, 23, 42, 0.55);
            border: 1px solid rgba(148, 163, 184, 0.28);
            border-radius: 7px;
            padding: 7px 8px;
            color: #dbeafe;
        }
        .ops-empty {
            opacity: 0.84;
        }
        .ops-service {
            padding: 6px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.16);
        }
        .ops-service:last-child {
            border-bottom: none;
        }
    </style>
</head>

<body>
    <div class="preview-controls">
        <div class="preview-title">UK Rail Vector View</div>
        <div id="rail-status" class="preview-status">Loading single-source rail map...</div>
        <div class="preview-note">
            Source: OpenRailwayMap standard style (single provider). Display constrained to UK bounds.
        </div>
        <div class="ops-block">
            <label for="nr-crs-inline" class="ops-label">Station (CRS)</label>
            <input id="nr-crs-inline" class="ops-input" type="text" list="nr-crs-inline-list" placeholder="e.g. KGX or Kings Cross" />
            <datalist id="nr-crs-inline-list"></datalist>
            <select id="nr-board-type-inline" class="ops-select">
                <option value="departures">Departures</option>
                <option value="arrivals">Arrivals</option>
            </select>
            <div class="ops-actions">
                <button id="nr-fetch-inline" class="ops-btn" type="button">Fetch Board</button>
                <button id="nr-disrupt-inline" class="ops-btn alt" type="button">Disruptions</button>
                <button id="nr-clear-inline" class="ops-btn alt" type="button">Clear</button>
            </div>
            <div id="nr-inline-results" class="ops-results"><div class="ops-empty">Rail ops ready.</div></div>
        </div>
    </div>
    <div id="map"></div>

    <script>
    const ormConfig = {
        styleUrl: "https://openrailwaymap.app/style/standard.json"
    };
    const ukBounds = [
        [-11.5, 49.5],
        [2.8, 61.2]
    ];
    const searchParams = new URLSearchParams(window.location.search);
    const requestedLng = Number(searchParams.get("lng"));
    const requestedLat = Number(searchParams.get("lat"));
    const requestedZoom = Number(searchParams.get("z"));
    const hasRequestedView =
        Number.isFinite(requestedLng) &&
        Number.isFinite(requestedLat) &&
        Number.isFinite(requestedZoom);
    const startCenter = hasRequestedView ? [requestedLng, requestedLat] : [-2.5879, 51.4545];
    const startZoom = hasRequestedView ? Math.max(5, Math.min(13, requestedZoom)) : 6;

    function setRailStatus(message, kind = "info") {
        const el = document.getElementById("rail-status");
        if (!el) return;
        el.textContent = message;
        if (kind === "error") {
            el.style.borderColor = "rgba(239,68,68,0.45)";
            el.style.color = "#fecaca";
        } else if (kind === "ok") {
            el.style.borderColor = "rgba(34,197,94,0.38)";
            el.style.color = "#bbf7d0";
        } else {
            el.style.borderColor = "rgba(148, 163, 184, 0.28)";
            el.style.color = "#bfdbfe";
        }
    }

    let map = null;
    let stationMarker = null;
    let stationSuggestTimer = null;
    const stationLookupByKey = new Map();

    function escapeHtml(raw) {
        return String(raw || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
    }

    function parseCrs(raw) {
        const text = String(raw || "").trim().toUpperCase();
        if (/^[A-Z]{3}$/.test(text)) return text;
        const m = text.match(/\b([A-Z]{3})\b/);
        return m ? m[1] : "";
    }

    async function fetchJson(path) {
        const r = await fetch(path, { headers: { Accept: "application/json" } });
        if (!r.ok) {
            let detail = "";
            try { detail = await r.text(); } catch (_) {}
            throw new Error(`HTTP ${r.status}${detail ? ` ${String(detail).slice(0, 160)}` : ""}`);
        }
        return r.json();
    }

    async function fetchStationSuggestions(q) {
        const params = new URLSearchParams({ q: String(q || ""), limit: "20" });
        const payload = await fetchJson(`/nre/stations?${params.toString()}`);
        return Array.isArray(payload?.stations) ? payload.stations : [];
    }

    function renderStationDatalist(rows) {
        const list = document.getElementById("nr-crs-inline-list");
        if (!list) return;
        stationLookupByKey.clear();
        const items = Array.isArray(rows) ? rows : [];
        list.innerHTML = items.slice(0, 40).map((st) => {
            const crs = String(st?.crsCode || st?.crs || "").toUpperCase();
            const name = String(st?.stationName || st?.name || "");
            const key = `${crs} - ${name}`;
            stationLookupByKey.set(key.toUpperCase(), { crs, name, lat: st?.lat, lon: st?.lon });
            return `<option value="${escapeHtml(key)}"></option>`;
        }).join("");
    }

    function setOpsHtml(html) {
        const wrap = document.getElementById("nr-inline-results");
        if (wrap) wrap.innerHTML = html;
    }

    function normalizeBoard(raw, crsFallback = "") {
        const safe = (raw && typeof raw === "object") ? raw : {};
        const services = Array.isArray(safe.trainServices) ? safe.trainServices : [];
        return {
            locationName: String(safe.locationName || ""),
            crs: String(safe.crs || crsFallback || ""),
            generatedAt: String(safe.generatedAt || ""),
            services: services.map((svc) => ({
                std: String(svc?.std || ""),
                etd: String(svc?.etd || ""),
                sta: String(svc?.sta || ""),
                eta: String(svc?.eta || ""),
                platform: String(svc?.platform || ""),
                operator: String(svc?.operator || ""),
                destination: Array.isArray(svc?.destination) ? svc.destination.map((x) => String(x?.locationName || "")).filter(Boolean) : [],
                origin: Array.isArray(svc?.origin) ? svc.origin.map((x) => String(x?.locationName || "")).filter(Boolean) : []
            }))
        };
    }

    async function focusStationOnMap(crs, fallbackName = "") {
        try {
            const rows = await fetchStationSuggestions(crs);
            const exact = rows.find((r) => String(r?.crsCode || r?.crs || "").toUpperCase() === String(crs || "").toUpperCase()) || rows[0];
            const lat = Number(exact?.lat);
            const lon = Number(exact?.lon || exact?.long);
            if (!Number.isFinite(lat) || !Number.isFinite(lon) || !map) return;
            map.flyTo({ center: [lon, lat], zoom: Math.max(9, map.getZoom()), speed: 0.9 });
            if (stationMarker) stationMarker.remove();
            stationMarker = new maplibregl.Marker({ color: "#22d3ee" })
                .setLngLat([lon, lat])
                .setPopup(new maplibregl.Popup({ offset: 18 }).setHTML(`<strong>${escapeHtml(fallbackName || exact?.stationName || crs)}</strong><br>${escapeHtml(crs)}`))
                .addTo(map);
        } catch (_) {
            // silent
        }
    }

    async function runBoardFetch() {
        const input = document.getElementById("nr-crs-inline");
        const typeSel = document.getElementById("nr-board-type-inline");
        const crs = parseCrs(input?.value || "");
        if (!/^[A-Z]{3}$/.test(crs)) {
            setOpsHtml('<div class="ops-empty">Use a 3-letter CRS code (e.g. KGX).</div>');
            return;
        }
        try {
            const params = new URLSearchParams({
                crs,
                type: String(typeSel?.value || "departures"),
                rows: "12"
            });
            const raw = await fetchJson(`/raildata/live-board?${params.toString()}`);
            const board = normalizeBoard(raw, crs);
            const ts = board.generatedAt ? new Date(board.generatedAt).toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit", second: "2-digit" }) : "--:--";
            const services = board.services || [];
            let html = `<div><strong>${escapeHtml(board.locationName || crs)} (${escapeHtml(board.crs || crs)})</strong><br>Updated ${escapeHtml(ts)} | ${services.length} services</div>`;
            if (!services.length) {
                html += '<div class="ops-empty" style="margin-top:6px;">No live services returned.</div>';
            } else {
                html += services.slice(0, 20).map((svc) => {
                    const when = String(typeSel?.value || "departures") === "arrivals"
                        ? (svc.eta || svc.sta || "--")
                        : (svc.etd || svc.std || "--");
                    const endpoint = String(typeSel?.value || "departures") === "arrivals"
                        ? ((svc.origin && svc.origin[0]) || "Origin")
                        : ((svc.destination && svc.destination[0]) || "Destination");
                    return `<div class="ops-service"><strong>${escapeHtml(endpoint)}</strong><br>${escapeHtml(when)} | Plat ${escapeHtml(svc.platform || "--")} | ${escapeHtml(svc.operator || "")}</div>`;
                }).join("");
            }
            setOpsHtml(html);
            await focusStationOnMap(crs, board.locationName || crs);
        } catch (err) {
            setOpsHtml(`<div class="ops-empty">Live board failed: ${escapeHtml(err?.message || err)}</div>`);
        }
    }

    function pickDisruptionRows(payload) {
        const root = (payload && typeof payload === "object") ? payload : {};
        const candidates = [
            root.incidents, root.disruptions, root.messages, root.items,
            root.data?.incidents, root.data?.disruptions, root.result?.incidents
        ];
        const arr = candidates.find((v) => Array.isArray(v));
        return Array.isArray(arr) ? arr : [];
    }

    function disruptionText(item) {
        if (typeof item === "string") return item;
        if (!item || typeof item !== "object") return "";
        return String(item.summary || item.title || item.description || item.message || item.reason || "").trim();
    }

    async function runDisruptionsFetch() {
        try {
            const payload = await fetchJson("/raildata/disruptions");
            const rows = pickDisruptionRows(payload);
            if (!rows.length) {
                setOpsHtml('<div class="ops-empty">No disruption rows returned.</div>');
                return;
            }
            const html = `<div><strong>Disruptions</strong> (${rows.length})</div>` + rows.slice(0, 25).map((r) => {
                const text = disruptionText(r);
                return `<div class="ops-service">${escapeHtml(text || JSON.stringify(r).slice(0, 180))}</div>`;
            }).join("");
            setOpsHtml(html);
        } catch (err) {
            setOpsHtml(`<div class="ops-empty">Disruption fetch failed: ${escapeHtml(err?.message || err)}</div>`);
        }
    }

    (async function initMap() {
        map = new maplibregl.Map({
            container: "map",
            style: ormConfig.styleUrl,
            center: startCenter,
            zoom: startZoom,
            minZoom: 5,
            maxZoom: 20,
            maxBounds: ukBounds
        });

        map.addControl(new maplibregl.NavigationControl(), "top-right");
        map.addControl(new maplibregl.AttributionControl({
            compact: true,
            customAttribution: '<a href="https://github.com/hiddewie/OpenRailwayMap-vector" target="_blank" rel="noopener noreferrer">OpenRailwayMap-vector</a> | <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener noreferrer">OpenStreetMap contributors</a>'
        }));

        map.on("load", () => {
            if (!hasRequestedView) {
                map.fitBounds(ukBounds, { padding: 28, duration: 0 });
            }
            setRailStatus("Rail map loaded from single source.", "ok");
        });

        map.on("error", () => {
            setRailStatus("Rail map source unavailable.", "error");
        });

        const fetchBtn = document.getElementById("nr-fetch-inline");
        const disBtn = document.getElementById("nr-disrupt-inline");
        const clearBtn = document.getElementById("nr-clear-inline");
        const input = document.getElementById("nr-crs-inline");

        fetchBtn?.addEventListener("click", runBoardFetch);
        disBtn?.addEventListener("click", runDisruptionsFetch);
        clearBtn?.addEventListener("click", () => {
            setOpsHtml('<div class="ops-empty">Rail ops ready.</div>');
            if (stationMarker) {
                stationMarker.remove();
                stationMarker = null;
            }
        });
        input?.addEventListener("keydown", (ev) => {
            if (ev.key === "Enter") {
                ev.preventDefault();
                runBoardFetch();
            }
        });
        input?.addEventListener("input", () => {
            const q = String(input.value || "").trim();
            if (stationSuggestTimer) clearTimeout(stationSuggestTimer);
            stationSuggestTimer = setTimeout(async () => {
                if (!q || q.length < 2) return;
                try {
                    const stations = await fetchStationSuggestions(q);
                    renderStationDatalist(stations);
                } catch (_) {
                    // ignore suggestion failures
                }
            }, 180);
        });
        input?.addEventListener("change", () => {
            const key = String(input.value || "").trim().toUpperCase();
            const hit = stationLookupByKey.get(key);
            if (hit?.crs) input.value = hit.crs;
        });
    })();
    </script>
</body>
</html>
